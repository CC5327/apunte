<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><link rel=preload as=font href=/fonts/vendor/jost/jost-v4-latin-regular.woff2 type=font/woff2 crossorigin><link rel=preload as=font href=/fonts/vendor/jost/jost-v4-latin-700.woff2 type=font/woff2 crossorigin><link rel=stylesheet href=/main.034d9cba9deb1f52db75fa0931ca0fc2bba85beb0b9acc665c7d9736bb78dd22a4631f6e5e1f60c880c640e8a2fa42a2ef762e82830c85f9e4a30d8d52c2a6e9.css integrity="sha512-A02cup3rH1LbdfoJMcoPwruoW+sLmsxmXH2XNrt43SKkYx9uXh9gyIDGQOii+kKi73YugoMMhfnkow2NUsKm6Q==" crossorigin=anonymous><noscript><style>img.lazyload{display:none}</style></noscript><meta name=robots content="index, follow"><meta name=googlebot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><meta name=bingbot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><title>Tarea 3: Buffer Overflows - Introducci칩n a la Seguridad Computacional</title><meta name=description content="DCC universidad de Chile"><link rel=canonical href=/tareas/tarea-3/><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="/logo_redondo.png"><meta name=twitter:title content="Tarea 3: Buffer Overflows"><meta name=twitter:description content="Instrucciones La siguiente actividad est치 pensada para su desarrollo en un bloque de auxiliar y un poco m치s (~3 horas), en grupos de dos personas como m치ximo. Al igual que en la tarea anterior, antes de partir, recuerden leer la secci칩n de reglas de tareas.
Pregunta 칰nica: Shellcode El objetivo de esta pregunta es explotar manualmente una vulnerabilidad de tipo buffer overflow en el binario de este archivo comprimido entregado con ayuda de GDB."><meta name=twitter:site content="@dccuchile"><meta name=twitter:creator content="@dccuchile"><meta property="og:title" content="Tarea 3: Buffer Overflows"><meta property="og:description" content="Instrucciones La siguiente actividad est치 pensada para su desarrollo en un bloque de auxiliar y un poco m치s (~3 horas), en grupos de dos personas como m치ximo. Al igual que en la tarea anterior, antes de partir, recuerden leer la secci칩n de reglas de tareas.
Pregunta 칰nica: Shellcode El objetivo de esta pregunta es explotar manualmente una vulnerabilidad de tipo buffer overflow en el binario de este archivo comprimido entregado con ayuda de GDB."><meta property="og:type" content="article"><meta property="og:url" content="/tareas/tarea-3/"><meta property="og:image" content="/logo_redondo.png"><meta property="article:published_time" content="2020-06-05T09:00:00-03:00"><meta property="article:modified_time" content="2022-05-12T19:16:10-04:00"><meta property="og:site_name" content="Introducci칩n a la Seguridad Computacional"><meta property="article:publisher" content="https://www.facebook.com/DCCUChile"><meta property="article:author" content="https://www.facebook.com/DCCUChile"><meta property="og:locale" content="es_CL"><script type=application/ld+json>{"@context":"http://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Home","item":"\/"},{"@type":"ListItem","position":2,"name":"Tareastarea 3","item":"\/tareastarea-3\/"}]}</script><meta name=theme-color content="#fff"><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest></head><body class="tareas single"><div class="header-bar fixed-top"></div><header class="navbar fixed-top navbar-expand-md navbar-light"><div class=container><input class="menu-btn order-0" type=checkbox id=menu-btn>
<label class="menu-icon d-md-none" for=menu-btn><span class=navicon></span></label><a class="navbar-brand order-1 order-md-0 mr-auto" href=/><img class=logo-light src=/images/banner.svg></img>
<img class=logo-dark src=/images/banner_dark.svg></img></a>
<button id=mode class="btn btn-link order-2 order-md-4" type=button aria-label="Toggle mode">
<span class=toggle-dark><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-moon"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg></span><span class=toggle-light><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-sun"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></span></button><ul class="navbar-nav social-nav order-3 order-md-5"><li class=nav-item><a class=nav-link href=https://github.com/cc5327/apunte><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77a5.44 5.44.0 00-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg><span class="ml-2 sr-only">GitHub</span></a></li></ul><div class="collapse navbar-collapse order-4 order-md-1"><ul class="navbar-nav main-nav mr-auto order-5 order-md-2"><li class=nav-item><a class=nav-link href=/acerca>Info</a></li><li class=nav-item><a class=nav-link href=/auxiliares/enunciados/auxiliar-1>Auxiliares</a></li><li class=nav-item><a class=nav-link href=/tareas/>Tareas</a></li></ul><div class="break order-6 d-md-none"></div><form class="navbar-form flex-grow-1 order-7 order-md-3"><input id=userinput class="form-control is-search" type=search placeholder="Buscar Documentaci칩n..." aria-label="Buscar Documentaci칩n..." autocomplete=off><div id=suggestions class="shadow bg-white rounded"></div></form></div></div></header><div class="wrap container" role=document><div class=content><div class="row justify-content-center"><div class="col-md-12 col-lg-10 col-xl-8"><article><div class=blog-header><h1>Tarea 3: Buffer Overflows</h1><p><small>Publicado el 05/06/2020&nbsp;&dash;&nbsp;<strong>Lectura de 6&nbsp;mins</strong></small><p></div><p class=lead></p><h2 id=instrucciones>Instrucciones</h2><p>La siguiente actividad est치 pensada para su desarrollo en un bloque de auxiliar y un poco m치s (~3 horas), en grupos de dos personas como m치ximo. Al igual que en la tarea anterior, antes de partir, recuerden leer la secci칩n de <a href=reglas>reglas de tareas</a>.</p><h3 id=pregunta-칰nica-shellcode>Pregunta 칰nica: Shellcode</h3><p>El objetivo de esta pregunta es explotar manualmente una vulnerabilidad de tipo <em>buffer overflow</em> en <a href=buffer_overflow.zip>el binario de este archivo comprimido</a> entregado con ayuda de GDB. Lo anterior deben realizarlo para que corra de forma apropiada en la <a href="https://drive.google.com/open?id=1W9Mz843KbC1PympEOwSzeER9FE-6DftR">m치quina virtual</a> del curso. Para resolver esta pregunta de forma m치s c칩moda, puede apoyarse con scripts de Python que le ayuden a generar autom치ticamente las entradas.</p><p>El binario y el fuente que deben atacar lo pueden descargar desde <a href=buffer_overflow.zip>este enlace</a>. Su 칰nica funci칩n es recibir el texto entregado como primer argumento, copiarlo a un buffer de un tama침o limitado, y luego terminar.</p><div class="alert alert-warning d-flex" role=alert><div class="flex-shrink-1 alert-icon">游녤</div><div class=w-100><p>Si tienen problemas ejecutando <code>buffer_overflow</code>, deben activar el permiso de ejecuci칩n con este comando:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>sudo chmod +x buffer_overflow
</code></pre></div><p>Las credenciales de la m치quina las pueden encontrar en la <a href=../../auxiliares/enunciados/auxiliar-4>auxiliar 4</a>.</p></div></div><h4 id=obtener-la-direcci칩n-de-memoria-del-inicio-del-buffer-y-determinar-la-ubicaci칩n-en-la-pila-de-ret-que-usa-el-frame-f--3-puntos>Obtener la direcci칩n de memoria del inicio del buffer y determinar la ubicaci칩n en la pila de <code>ret</code> que usa el frame f (3 puntos)</h4><p>a. (1,5 puntos) Utilizando GDB, depuren el binario para determinar la direcci칩n de memoria del inicio del buffer. Adjunten una captura GDB mostrando la direcci칩n de inicio del buffer e indiquen ya sea en la imagen o en texto cu치l es la direcci칩n de memoria buscada en cada caso.</p><p>b. (1,5 puntos) Determinen el espacio de memoria en el cual se guarda la direcci칩n de retorno que usa el frame <code>f</code> al entrar a la funci칩n que copia el buffer utilizando GDB. Para ello, les recomendamos que ejecuten el programa sin overflow, ubiquen la l칤nea en que se ejecuta <code>strcpy</code> al buffer, revisen el estado de la pila y finalmente identifiquen el valor que 칠sta contiene al momento de salir del frame (es decir, qu칠 direcci칩n de memoria se apunta). Adjunten en el informe la direcci칩n de memoria que determinaron en cada caso con una captura de pantalla de GDB mostr치ndola.</p><h4 id=crear-nop-slide-y-saltar-al-inicio-del-buffer-2-puntos>Crear NOP Slide y saltar al inicio del buffer (2 puntos)</h4><p>Desde esta parte, formaremos el payload necesario para ejecutar el ataque de desborde de buffer.</p><p>Sabiendo la direcci칩n el inicio del buffer y la direcci칩n de <code>ret</code>, calculen la cantidad de bytes entre ambas direcciones. Compruebe que una cadena de texto de prueba de ese tama침o pasada como entrada al programa lo hace caerse (ya que est치 sobreescribiendo <code>ret</code> con parte de su texto).</p><p>Luego de realizar lo anterior, reemplacen algunos de los caracteres de su cadena de prueba por un NOP slide de un tama침o razonable (>=24 bytes) utilizando la funci칩n de bash <code>printf</code> de la siguiente forma:</p><p><code>printf "\x90\x90\x90"</code></p><p>Lo anterior imprime tres veces el caracter de c칩digo hexadecimal <code>0x90</code></p><p>Para hacer el reemplazo, les recomendamos usar interpolaci칩n de valores en bash. A continuaci칩n mostramos un ejemplo:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>./lab2 <span class=k>$(</span><span class=nb>printf</span> <span class=s2>&#34;\x90\x90\x90\x90\x90\x90&lt;...&gt;&#34;</span><span class=k>)</span>aaaaaaaaaaaaaaaa...
</code></pre></div><p>Esto imprimir치 el byte \0x90 (NOP) una cantidad de veces determinada, seguido del caracter <code>a</code>. Tengan cuidado con no poner espacios entre <code>$()</code> y el texto porque ser치n considerados como entradas distintas.</p><p>Por 칰ltimo, reemplacen los 칰ltimos bytes del payload que est치 armando por una direcci칩n de memoria cercana al inicio del buffer, en la que se encuentre alg칰n byte del <em>NOP Slide</em>.</p><p>Es importante tener en cuenta que no es posible ingresar el byte \x00. Esto es f치cil de solucionar si es que el valor original en la posici칩n que queremos reemplazar ya ten칤a estos \x00, ya que bastar칤a con dejarlos intactos. Les recomendamos que hagan varias pruebas con distintos largos y vayan viendo c칩mo queda la pila en cada caso</p><p>Tambi칠n es importante tener en cuenta que los valores se guardan en x86_64 en formato little endian, es decir, la direcci칩n de memoria <code>0x0123456789abcdef</code> se escribir칤a como <code>$(printf "\xef\xcd\xab\x89\x\x67\x45\x23\x01")</code></p><p>Para la revisi칩n de esta secci칩n, es necesario que env칤en una captura de la pila en GDB al momento de terminar la copia de la variable externa. En esta captura deben destacar tanto el NOP slide como la direcci칩n de retorno (que debe estar en el mismo lugar que la mostrada en la parte 1).</p><h4 id=inyectar-shellcode-1-punto>Inyectar Shellcode (1 punto)</h4><p>Finalmente, queda agregar el shellcode al payload gener치ndose.A continuaci칩n les adjuntamos un shellcode v치lido para su uso en x64. Este shellcode levanta un terminal al ejecutarse.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash><span class=se>\x</span>48<span class=se>\x</span>31<span class=se>\x</span>f6<span class=se>\x</span>56<span class=se>\x</span>48<span class=se>\x</span>bf<span class=se>\x</span>2f<span class=se>\x</span>62<span class=se>\x</span>69<span class=se>\x</span>6e<span class=se>\x</span>2f<span class=se>\x</span>2f<span class=se>\x</span>73<span class=se>\x</span>68<span class=se>\x</span>57<span class=se>\x</span>54<span class=se>\x</span>5f<span class=se>\x</span>6a<span class=se>\x</span>3b<span class=se>\x</span>58<span class=se>\x</span>99<span class=se>\x</span>0f<span class=se>\x</span><span class=m>05</span>
</code></pre></div><p><a href=https://www.exploit-db.com/shellcodes/46907>Fuente</a></p><p>Agregue el shellcode inmediatamente a continuaci칩n del NOP slide <strong>pero dejando una cantidad de bytes de relleno entre 칠l y el final del buffer</strong>. Comente las razones por las que cree que el shellcode no se puede colocar directamente al final del buffer.</p><p>Finalmente, ejecute el programa y compruebe que el shellcode se ejecuta, levant치ndose un terminal al correr el programa con el input alterado. Para probar el buen funcionamiento del terminal, ejecute algunos comandos en 칠l (ejemplo: <code>whoami</code>, <code>echo "hola"</code>, <code>ls</code>). Agregue una captura del shellcode ejecutado y el terminal funcionando y adjunte el texto de entrada completo (con NOP slide, shellcode, relleno y direcci칩n de retorno) que gener칩.</p><h4 id=pregunta-extra-1-repetir-el-experimento-pero-sin-ayuda-de-gdb-hasta-05-puntos-extra-para-cualquier-quiz-se-puede-entregar-de-forma-individual-o-grupal>Pregunta Extra 1: repetir el experimento, pero sin ayuda de GDB (hasta 0.5 puntos extra para cualquier quiz, se puede entregar de forma individual o grupal)</h4><p>Probablemente, si ejecutan el payload sin GDB, 칠ste no funcione. La raz칩n de esto es que las variables de ambiente cargadas con GDB y sin GDB son distintas, y 칠stas ocupan un espacio en la memoria del proceso que hace que cambien ligeramente las direcciones de memoria de la pila. En el anexo de GDB hay un enlace a Stack Overflow explicando mejor estas razones y c칩mo solucionar el problema.</p><p>Para obtener esta bonificaci칩n, es necesario que expliquen detalladamente un m칠todo para poder encontrar las direcciones de memoria correctas al ejecutar el programa con un payload sin GDB, adem치s de por qu칠 funcionar칤a (no es necesario que sea la m치s eficiente). Para la evaluaci칩n, deben adjuntar los pasos a seguir para replicar su m칠todo y una captura de pantalla que muestre que su m칠todo funciona. La respuesta no puede usar el script del enlace de Stack Overflow del anexo de GDB (aunque si la citan pueden entregar una explicaci칩n basada en ella).</p><h4 id=pregunta-extra-2-usar-otros-shellcode-hasta-05-puntos-extra-para-cualquier-quiz-se-puede-entregar-de-forma-individual-o-grupal>Pregunta Extra 2: Usar otros shellcode (hasta 0.5 puntos extra para cualquier quiz, se puede entregar de forma individual o grupal)</h4><p>Busque otros shellcode para Linux x86/64 que le interesen e intente agregarlos como payload a su ataque. Para completar este objetivo, debe adjuntar el enlace a la fuente del shellcode usado, el texto de entrada completo y la captura del shellcode ejecut치ndose.</p><h4 id=pregunta-extra-3-crear-su-propio-shellcode-hasta-1-punto-extra-para-cualquier-quiz-se-puede-entregar-solamente-de-forma-individual>Pregunta Extra 3: Crear su propio shellcode (hasta 1 punto extra para cualquier quiz, se puede entregar solamente de forma individual)</h4><p>Explique detalladamente c칩mo crear shellcode para Linux x86_64 y entregue un <code>shellcode</code> creado por usted siguiendo ese m칠todo (no tiene que ser necesariamente complejo, basta con que ejecuten c칩digo no presente en el programa original). Puede usar librer칤as y programas externos existentes siempre y cuando los cite y explique en qu칠 aporta cada uno de ellos. Para completar este objetivo, debe adjuntar la descripci칩n de c칩mo hacerlo, el shellcode junto con una descripci칩n de qu칠 hace, el comando completo y una captura del shellcode funcionando.</p><h3 id=cr칠ditos-y-m치s-informaci칩n>Cr칠ditos y m치s informaci칩n</h3><ul><li><p>Esta pregunta est치 inspirada en el contenido del curso online de desarrollo de exploits de <a href=https://samsclass.info/127/127_F15.shtml>samclass.info</a>. Si quieren adentrarse en la parte pr치ctica de estos ataques, es un buen punto para partir.</p></li><li><p>Si quieren conocer m치s de shellcodes, les recomendamos el libro <code>A Shellcoder's Handbook</code>. A pesar de ser algo antiguo, es una lectura entretenida para entender c칩mo funcionan los shellcodes.</p></li></ul></article></div></div></div></div><footer class="footer text-muted"><div class=container><div class=row><div class="col-lg-8 order-last order-lg-first"><ul class=list-inline><li class=list-inline-item>Sitio generado con <a href=https://gohugo.io/>Hugo</a> y <a href=https://getdoks.org/>Doks</a></li></ul></div><div class="col-lg-8 order-first order-lg-last text-lg-right"><ul class=list-inline><a href="http://creativecommons.org/licenses/by-sa/4.0/?ref=chooser-v1" target=_blank rel="license noopener noreferrer" style=display:inline-block>CC BY-SA 4.0<img style=height:22px!important;margin-left:3px;vertical-align:text-bottom src="https://mirrors.creativecommons.org/presskit/icons/cc.svg?ref=chooser-v1"><img style=height:22px!important;margin-left:3px;vertical-align:text-bottom src="https://mirrors.creativecommons.org/presskit/icons/by.svg?ref=chooser-v1"><img style=height:22px!important;margin-left:3px;vertical-align:text-bottom src="https://mirrors.creativecommons.org/presskit/icons/sa.svg?ref=chooser-v1"></a></ul></div></div></div></footer><script src=/main.2507c05f91ee016250e43b67b3d342f5a0d9d4dc5264f76cdc4518cd36a9e04cf3022ce8362802e618d8130b6733b53ee845a49e67229eeb3d3e70347db96a2b.js integrity="sha512-JQfAX5HuAWJQ5Dtns9NC9aDZ1NxSZPds3EUYzTap4EzzAizoNigC5hjYEwtnM7U+6EWknmcinus9PnA0fblqKw==" crossorigin=anonymous defer></script><script src=/index.min.95c2fb57984ca6cb1914e6658c1095cc47073a398c805d5ee842114fab739d64b4d5cd0626cda1be56c95e7f8c6e9c4d231866d1065245c873d731a6a7b01c5e.js integrity="sha512-lcL7V5hMpssZFOZljBCVzEcHOjmMgF1e6EIRT6tznWS01c0GJs2hvlbJXn+MbpxNIxhm0QZSRchz1zGmp7AcXg==" crossorigin=anonymous defer></script><script>MathJax={tex:{inlineMath:[['$','$'],['\\(','\\)']],displayMath:[['$$','$$'],['\\[','\\]']],processEscapes:true,processEnvironments:true},options:{skipHtmlTags:['script','noscript','style','textarea','pre']}};window.addEventListener('load',(event)=>{document.querySelectorAll("mjx-container").forEach(function(x){x.parentElement.classList+='has-jax'})});</script><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script type=text/javascript id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script></body></html>